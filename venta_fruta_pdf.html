<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Recepción y Venta de Fruta</title>
    <!-- Carga Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" 
            xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer"></script>
            
    <style>
        /* Estilos base */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para la factura */
        #invoice-preview {
            max-width: 750px;
            width: 100%;
            margin: 0 auto;
            border: 1px solid #ddd;
            padding: 24px;
            font-family: 'Times New Roman', Times, serif;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background: white;
            color: black;
        }
        #invoice-preview .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #ccc;
            padding-bottom: 20px;
        }
        #invoice-preview .company-details {
            font-size: 14px;
            line-height: 1.4;
        }
        #invoice-preview .company-details img {
            width: 120px;
            margin-bottom: 10px;
        }
        #invoice-preview .invoice-title {
            text-align: right;
        }
        #invoice-preview .invoice-title h1 {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        #invoice-preview .invoice-meta {
            font-size: 14px;
        }
        #invoice-preview .bill-to {
            margin-top: 20px;
            font-size: 14px;
        }
        #invoice-preview .bill-to strong {
            font-size: 12px;
            text-transform: uppercase;
            color: #555;
        }
        #invoice-preview .invoice-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        #invoice-preview .invoice-table th, 
        #invoice-preview .invoice-table td {
            border-bottom: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }
        #invoice-preview .invoice-table th {
            background-color: #eee;
            color: #333;
            text-transform: uppercase;
            font-size: 12px;
            font-weight: bold;
        }
        #invoice-preview .invoice-table td {
            vertical-align: top;
        }
        #invoice-preview .invoice-table .text-right {
            text-align: right;
        }
        #invoice-preview .invoice-summary {
            margin-top: 20px;
            float: right;
            width: 250px;
            font-size: 14px;
        }
        #invoice-preview .invoice-summary div {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        #invoice-preview .invoice-summary div strong {
            font-weight: bold;
        }
        #invoice-preview .invoice-summary .total {
            font-size: 16px;
            font-weight: bold;
            border-top: 2px solid #333;
            padding-top: 8px;
            margin-top: 8px;
        }
        #invoice-preview .invoice-footer {
            clear: both;
            margin-top: 40px;
            text-align: center;
            font-size: 12px;
            color: #555;
            padding-top: 10px;
            border-top: 1px solid #ccc;
        }

        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            /* Transición */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 24px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 95%;
            max-width: 1000px;
            position: relative;
            /* Transición */
            transform: translateY(-50px);
            transition: transform 0.3s ease;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .modal-body {
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
        }
        /* Estilo para botones de acción en tablas */
        .action-btn {
            @apply py-1 px-2 rounded-md text-xs font-medium;
        }
        .edit-btn {
            @apply bg-yellow-100 text-yellow-800 hover:bg-yellow-200;
        }
        .delete-btn {
            @apply bg-red-100 text-red-800 hover:bg-red-200;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Sistema de Recepción y Venta</h1>
            <p class="text-gray-600">Gestión de inventario de materia prima y generación de facturas de venta.</p>
        </div>

        <!-- Panel de Estado -->
        <div id="status-panel" class="mb-4 p-3 rounded-lg text-white font-semibold text-sm flex items-center justify-center transition-all duration-300 bg-gray-400">
            <span id="status-message">Inicializando...</span>
        </div>

        <!-- 1. Formulario de Recepción -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. Registrar Recepción de Materia Prima</h2>
            
            <form id="reception-form" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Datos de Trazabilidad -->
                <fieldset class="md:col-span-3">
                    <legend class="text-lg font-medium text-gray-700 mb-2">Datos de Trazabilidad</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="reception-date" class="block text-sm font-medium text-gray-700">Fecha Recepción *</label>
                            <input type="date" id="reception-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="producer-name" class="block text-sm font-medium text-gray-700">Nombre Productor *</label>
                            <input type="text" id="producer-name" value="Pinebloom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="lot-name" class="block text-sm font-medium text-gray-700">Nombre Predio / Lote</label>
                            <input type="text" id="lot-name" value="Pinebloom Orange" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                </fieldset>

                <!-- Datos del Producto -->
                <fieldset class="md:col-span-3">
                    <legend class="text-lg font-medium text-gray-700 mb-2">Datos del Producto</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="species" class="block text-sm font-medium text-gray-700">Especie</label>
                            <input type="text" id="species" value="Naranjas" class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly>
                        </div>
                        <div>
                            <label for="variety" class="block text-sm font-medium text-gray-700">Variedad</label>
                            <input type="text" id="variety" value="Valencia" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="net-weight" class="block text-sm font-medium text-gray-700">Peso Neto (Kg) *</label>
                            <input type="number" id="net-weight" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                </fieldset>
                
                <div class="md:col-span-3 text-right">
                    <div id="reception-error" class="text-red-600 text-sm mb-2 text-left"></div>
                    <button type="submit" id="submit-reception" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Registrar en Inventario
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Botón Crear Nueva Venta -->
        <div class="text-right mb-8">
            <button id="open-sale-modal-btn" class="py-2 px-5 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                + Crear Nueva Venta
            </button>
        </div>

        <!-- 2. Inventario en Cámara -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">2. Inventario en Cámara (Materia Prima)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lote ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock (Kg)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Filas de inventario se insertan aquí -->
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay materia prima en inventario.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 3. Resumen de Ventas -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-semibold">3. Resumen de Ventas (Facturas Generadas)</h2>
                <button id="download-csv-btn" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Descargar Excel (.csv)
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Factura #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Líneas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="sales-summary-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Filas de ventas se insertan aquí -->
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay ventas registradas.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Nueva Venta -->
    <div id="sale-modal" class="modal">
        <div class="modal-content">
            <span id="close-sale-modal" class="modal-close">&times;</span>
            <h2 class="text-2xl font-semibold mb-4">Generar Nueva Venta</h2>
            
            <form id="sale-form">
                <div class="modal-body p-2">
                    <!-- Datos del Cliente -->
                    <fieldset class="mb-4">
                        <legend class="text-lg font-medium text-gray-700 mb-2">Datos del Cliente</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="sale-customer" class="block text-sm font-medium text-gray-700">Facturar a (Bill To): *</label>
                                <input type="text" id="sale-customer" value="Jacmor Farms" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="sale-date" class="block text-sm font-medium text-gray-700">Fecha Factura: *</label>
                                <input type="date" id="sale-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="sale-invoice-id" class="block text-sm font-medium text-gray-700">Factura #: *</Iabel>
                                <input type="text" id="sale-invoice-id" value="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Líneas de Producto (Venta) -->
                    <fieldset class="mb-4">
                        <legend class="text-lg font-medium text-gray-700 mb-2">Líneas de Producto (Venta)</legend>
                        <div id="sale-product-lines" class="space-y-3 mb-3">
                            <!-- Filas de productos se añaden aquí dinámicamente -->
                        </div>
                        <button type="button" id="add-product-line-btn" class="py-1 px-3 border border-gray-400 rounded-md text-sm text-gray-700 hover:bg-gray-100">+ Añadir Línea de Producto</button>
                    </fieldset>

                    <!-- Descuento de Inventario (Materia Prima) -->
                    <fieldset class="mb-4">
                        <legend class="text-lg font-medium text-gray-700 mb-2">Descuento de Inventario (Materia Prima)</legend>
                        <div id="sale-inventory-lines" class="space-y-3 mb-3">
                            <!-- Filas de descuento de inventario se añaden aquí dinámicamente -->
                        </div>
                        <button type="button" id="add-inventory-line-btn" class="py-1 px-3 border border-gray-400 rounded-md text-sm text-gray-700 hover:bg-gray-100">+ Añadir Lote a Descontar</button>
                    </fieldset>

                </div>

                <div class="mt-6 px-2 pb-2 text-right bg-gray-50 rounded-b-lg">
                    <div id="sale-error-message" class="text-red-600 text-sm mb-2 text-left font-semibold"></div>
                    <button type="button" id="preview-invoice-btn" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Previsualizar Factura
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Previsualización de Factura -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content">
            <span id="close-invoice-modal" class="modal-close">&times;</span>
            <div class="modal-body" id="invoice-modal-body">
                <!-- Contenido de la factura (invoice-preview) se inyecta aquí -->
                <div id="invoice-preview" class="p-4 sm:p-6">
                    <!-- Cabecera -->
                    <div class="invoice-header">
                        <div class="company-details">
                            <img src="https://placehold.co/200x80/png?text=PINEBLOOM" alt="Logo Pinebloom Farms" class="w-32 mb-2">
                            <strong>Pinebloom Farms LLC</strong><br>
                            545 Tarva Road<br>
                            Albany, Georgia 31721<br>
                            1-229-734-5611<br>
                            pinebloompackingllc@gmail.com
                        </div>
                        <div class="invoice-title">
                            <h1>INVOICE</h1>
                            <div class="invoice-meta">
                                <div>DATE: <strong id="invoice-date-val"></strong></div>
                                <div>INVOICE #: <strong id="invoice-id-val"></strong></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cliente -->
                    <div class="bill-to">
                        <strong>TO:</strong>
                        <div id="invoice-customer-val" class="font-medium text-lg"></div>
                    </div>

                    <!-- Detalles de Pago (Estático como la imagen) -->
                    <table class="invoice-table mt-4">
                        <thead>
                            <tr>
                                <th style="width: 50%;">PAYMENT TERMS</th>
                                <th style="width: 50%;">DUE DATE</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Due on receipt</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Líneas de Items -->
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">QTY</th>
                                <th style="width: 50%;">DESCRIPTION</th>
                                <th style="width: 15%;" class="text-right">UNIT PRICE</th>
                                <th style="width: 20%;" class="text-right">LINE TOTAL</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items-body">
                            <!-- Las líneas de productos se insertan aquí -->
                        </tbody>
                    </table>

                    <!-- Resumen de Totales -->
                    <div class="invoice-summary">
                        <div>
                            <span>SUBTOTAL</span>
                            <span id="invoice-subtotal-val">$0.00</span>
                        </div>
                        <div>
                            <span>SALES TAX</span>
                            <span>$0.00</span>
                        </div>
                        <div class="total">
                            <strong>TOTAL</strong>
                            <strong id="invoice-total-val">$0.00</strong>
                        </div>
                    </div>
                    
                    <!-- Pie de página -->
                    <div class="invoice-footer">
                        Make all checks payable to Pinebloom Farms LLC
                    </div>
                </div>
            </div>
            
            <div id="invoice-modal-footer" class="mt-6 text-right bg-gray-50 p-4 rounded-b-lg">
                <span id="invoice-confirm-error" class="text-red-600 text-sm mr-4"></span>
                <button type="button" id="confirm-and-save-btn" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Confirmar y Guardar Venta
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Inventario -->
    <div id="edit-inventory-modal" class="modal">
        <div class="modal-content max-w-2xl">
            <span id="close-edit-inventory-modal" class="modal-close">&times;</span>
            <h2 class="text-2xl font-semibold mb-4">Editar Recepción de Inventario</h2>
            <form id="edit-inventory-form">
                <input type="hidden" id="edit-inventory-id">
                <div class="modal-body p-2 space-y-4">
                    <div>
                        <label for="edit-reception-date" class="block text-sm font-medium text-gray-700">Fecha Recepción *</label>
                        <input type="date" id="edit-reception-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="edit-producer-name" class="block text-sm font-medium text-gray-700">Nombre Productor *</label>
                        <input type="text" id="edit-producer-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="edit-description" class="block text-sm font-medium text-gray-700">Descripción (Lote, Especie, Variedad) *</label>
                        <input type="text" id="edit-description" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="edit-net-weight" class="block text-sm font-medium text-gray-700">Stock (Kg) *</label>
                        <input type="number" id="edit-net-weight" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <p class="mt-1 text-xs text-gray-500">Nota: Ajustar el stock aquí no afecta ventas pasadas. Use la anulación de ventas para eso.</p>
                    </div>
                </div>
                <div class="mt-6 px-2 pb-2 text-right bg-gray-50 rounded-b-lg">
                    <span id="edit-inventory-error" class="text-red-600 text-sm mr-4"></span>
                    <button type="submit" id="save-edit-inventory-btn" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmación Genérico -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content max-w-md">
            <h2 class="text-xl font-semibold mb-4" id="confirm-modal-title">¿Estás seguro?</h2>
            <div class_="modal-body">
                <p id="confirm-modal-body">Esta acción no se puede deshacer.</p>
            </div>
            <div class="mt-6 text-right space-x-3">
                <button type="button" id="confirm-modal-cancel-btn" class="py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancelar
                </button>
                <button type="button" id="confirm-modal-ok-btn" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Confirmar
                </button>
            </div>
        </div>
    </div>


    <!-- Imports de Firebase (Módulos) -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, writeBatch, runTransaction,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // --- Configuración de Firebase ---
        // Tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB5-1MpNQMnsPULW7JZZ8aRHC08UM3IVHY",
            authDomain: "orange-pbloom.firebaseapp.com",
            projectId: "orange-pbloom",
            storageBucket: "orange-pbloom.appspot.com", // Corregido: .appspot.com es lo habitual
            messagingSenderId: "306332234261",
            appId: "1:306332234261:web:a991cc5b30c2cfdfda941c",
            measurementId: "G-Z185FETY22"
        };
        
        // --- Variables Globales de la App ---
        let db, auth, userId, appId;
        let inventoryListener = null; // Para manejar el 'listener' de inventario
        let salesListener = null; // Para manejar el 'listener' de ventas
        let localInventoryCache = new Map(); // Cache local del inventario
        
        // --- Variables de estado de la Venta (para el modal) ---
        let currentSaleData = {
            customer: '',
            date: '',
            invoiceId: '',
            productLines: [], // { description, qty, price }
            inventoryLines: [], // { lotId, lotDesc, kgToDiscount }
            subtotal: 0,
            total: 0
        };

        // --- Elementos del DOM ---
        const statusPanel = document.getElementById('status-panel');
        const statusMessage = document.getElementById('status-message');
        const receptionForm = document.getElementById('reception-form');
        const receptionError = document.getElementById('reception-error');
        const inventoryTableBody = document.getElementById('inventory-table-body');
        const salesSummaryTableBody = document.getElementById('sales-summary-table-body');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        
        // Elementos del Modal de Venta
        const openSaleModalBtn = document.getElementById('open-sale-modal-btn');
        const saleModal = document.getElementById('sale-modal');
        const closeSaleModalBtn = document.getElementById('close-sale-modal');
        const saleForm = document.getElementById('sale-form');
        const saleProductLines = document.getElementById('sale-product-lines');
        const addProductLineBtn = document.getElementById('add-product-line-btn');
        const saleInventoryLines = document.getElementById('sale-inventory-lines');
        const addInventoryLineBtn = document.getElementById('add-inventory-line-btn');
        const saleErrorMessage = document.getElementById('sale-error-message');
        const previewInvoiceBtn = document.getElementById('preview-invoice-btn');

        // Elementos del Modal de Factura
        const invoiceModal = document.getElementById('invoice-modal');
        const closeInvoiceModalBtn = document.getElementById('close-invoice-modal');
        const invoiceModalBody = document.getElementById('invoice-modal-body');
        const invoicePreview = document.getElementById('invoice-preview');
        const confirmAndSaveBtn = document.getElementById('confirm-and-save-btn');
        const invoiceConfirmError = document.getElementById('invoice-confirm-error');

        // Elementos del Modal de Edición de Inventario
        const editInventoryModal = document.getElementById('edit-inventory-modal');
        const closeEditInventoryModalBtn = document.getElementById('close-edit-inventory-modal');
        const editInventoryForm = document.getElementById('edit-inventory-form');
        const editInventoryError = document.getElementById('edit-inventory-error');
        
        // Elementos del Modal de Confirmación
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalBody = document.getElementById('confirm-modal-body');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const confirmModalOkBtn = document.getElementById('confirm-modal-ok-btn');

        // Formateadores
        const { format: formatCurrency } = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
        const { format: formatNumber } = new Intl.NumberFormat('en-US');

        // --- Funciones de Utilidad (Modales) ---

        function showModal(modalElement) {
            if (modalElement) {
                console.log("Mostrando modal:", modalElement.id);
                modalElement.style.display = 'block';
                // Forzar repintado para que la transición funcione
                setTimeout(() => modalElement.classList.add('show'), 10);
            } else {
                console.error("Error: Elemento modal no encontrado.");
            }
        }

        function closeModal(modalElement) {
            if (modalElement) {
                console.log("Cerrando modal:", modalElement.id);
                modalElement.classList.remove('show');
                // Esperar a que termine la transición antes de ocultar
                setTimeout(() => modalElement.style.display = 'none', 300); 
            } else {
                console.error("Error: Elemento modal no encontrado.");
            }
        }
        
        /**
         * Muestra un modal de confirmación genérico.
         * @param {string} title - El título del modal.
         * @param {string} body - El mensaje del modal.
         * @param {string} okButtonText - Texto para el botón de confirmación.
         * @param {string} okButtonClass - Clases de Tailwind para el botón (ej. bg-red-600).
         * @returns {Promise<boolean>} - Resuelve a 'true' si se confirma, 'false' si se cancela.
         */
        function showConfirmationModal(title, body, okButtonText = 'Confirmar', okButtonClass = 'bg-red-600 hover:bg-red-700') {
            return new Promise((resolve) => {
                confirmModalTitle.textContent = title;
                confirmModalBody.textContent = body;
                confirmModalOkBtn.textContent = okButtonText;
                
                // Limpiar clases antiguas y añadir la nueva
                confirmModalOkBtn.className = `py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 ${okButtonClass}`;
                
                showModal(confirmModal);

                // Remover listeners anteriores para evitar duplicados
                const newOkBtn = confirmModalOkBtn.cloneNode(true);
                confirmModalOkBtn.parentNode.replaceChild(newOkBtn, confirmModalOkBtn);
                
                const newCancelBtn = confirmModalCancelBtn.cloneNode(true);
                confirmModalCancelBtn.parentNode.replaceChild(newCancelBtn, confirmModalCancelBtn);

                // Asignar nuevos listeners
                newOkBtn.addEventListener('click', () => {
                    closeModal(confirmModal);
                    resolve(true);
                });
                newCancelBtn.addEventListener('click', () => {
                    closeModal(confirmModal);
                    resolve(false);
                });
            });
        }

        // --- Lógica de Inicialización y Autenticación ---

        // Función para actualizar el estado visual
        function updateStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusPanel.classList.remove('bg-gray-400', 'bg-green-500', 'bg-red-500', 'bg-yellow-500');
            
            switch (type) {
                case 'success':
                    statusPanel.classList.add('bg-green-500');
                    break;
                case 'error':
                    statusPanel.classList.add('bg-red-500');
                    break;
                case 'warning':
                    statusPanel.classList.add('bg-yellow-500');
                    break;
                case 'info':
                default:
                    statusPanel.classList.add('bg-gray-400');
                    break;
            }
        }

        // Inicializa Firebase
        async function initFirebase() {
            try {
                updateStatus('Inicializando Firebase...', 'info');
                // ID de la app (para las reglas de Firestore)
                appId = typeof __app_id !== 'undefined' ? __app_id : 'orange-pbloom';
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Habilitar logs detallados de Firestore
                setLogLevel('Debug');
                
                updateStatus('Autenticando...', 'warning');
                
                // Manejar estado de autenticación
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Usuario ya autenticado (anónimo o con token)
                        userId = user.uid;
                        console.log('Usuario autenticado:', userId);
                        updateStatus('Conectado y Autenticado', 'success');
                        // Cargar datos
                        loadInventory();
                        loadSalesSummary();
                    } else {
                        // No hay usuario, intentar autenticar
                        await attemptSignIn();
                    }
                });

            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                updateStatus(`Error de inicialización: ${error.message}`, 'error');
            }
        }
        
        // Intento de inicio de sesión
        async function attemptSignIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    // 1. Intentar con token de la plataforma
                    console.log("Intentando signInWithCustomToken...");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // 2. Intentar anónimamente (si no hay token)
                    console.log("Intentando signInAnonymously...");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error('Error de autenticación:', error);
                // Si falla el token (mismatch), intentar anónimo
                if (error.code === 'auth/custom-token-mismatch') {
                    console.warn('Token mismatch, intentando anónimo...');
                    try {
                        await signInAnonymously(auth);
                    } catch (anonError) {
                        console.error('Error de autenticación anónima:', anonError);
                        updateStatus('Error de autenticación. Revise la consola (F12).', 'error');
                    }
                } else if (error.code === 'auth/operation-not-allowed' || error.code === 'auth/configuration-not-found') {
                    // Error común si la autenticación anónima no está habilitada
                    console.error('La autenticación anónima no está habilitada en Firebase.');
                    updateStatus('Error: La autenticación anónima no está habilitada en Firebase.', 'error');
                } else {
                    updateStatus(`Error de autenticación: ${error.message}`, 'error');
                }
            }
        }

        // --- Lógica de Recepción (CRUD Inventario) ---

        // Renderizar tabla de inventario
        function renderInventory(docs) {
            inventoryTableBody.innerHTML = ''; // Limpiar tabla
            localInventoryCache.clear(); // Limpiar cache local

            if (docs.empty) {
                inventoryTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay materia prima en inventario.</td></tr>';
                return;
            }

            docs.forEach(doc => {
                const item = doc.data();
                const lotId = doc.id;
                
                // Guardar en cache
                localInventoryCache.set(lotId, {
                    ...item, // Guardar el objeto completo
                    id: lotId
                });

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${lotId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.producer}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">${formatNumber(item.stockKg)} Kg</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button class="action-btn edit-btn" data-id="${lotId}">Editar</button>
                        <button class="action-btn delete-btn" data-id="${lotId}">Borrar</button>
                    </td>
                `;
                
                // Asignar eventos a los botones
                tr.querySelector('.edit-btn').addEventListener('click', () => openEditInventoryModal(lotId));
                tr.querySelector('.delete-btn').addEventListener('click', () => handleDeleteInventory(lotId));
                
                inventoryTableBody.appendChild(tr);
            });
        }
        
        // Cargar inventario (con listener en tiempo real)
        function loadInventory() {
            if (!db || !userId) return;

            // Desconectar listener anterior si existe
            if (inventoryListener) inventoryListener();

            const inventoryCollectionPath = `artifacts/${appId}/users/${userId}/inventory`;
            const q = query(collection(db, inventoryCollectionPath));

            console.log("Escuchando en:", inventoryCollectionPath);

            inventoryListener = onSnapshot(q, (snapshot) => {
                console.log("Inventario actualizado, docs:", snapshot.size);
                renderInventory(snapshot);
                // Actualizar los selectores en el modal de venta si está abierto
                updateInventorySelectors();
            }, (error) => {
                console.error("Error al cargar inventario: ", error);
                inventoryTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error al cargar inventario: ${error.message}</td></tr>`;
            });
        }
        
        // Manejar envío de formulario de recepción (CREATE)
        async function handleReceptionSubmit(e) {
            e.preventDefault();
            if (!db || !userId) {
                receptionError.textContent = "Error: No hay conexión a la base de datos.";
                return;
            }
            receptionError.textContent = "";
            const submitButton = document.getElementById('submit-reception');
            submitButton.disabled = true;
            submitButton.textContent = "Guardando...";
            
            try {
                const date = document.getElementById('reception-date').value;
                const producer = document.getElementById('producer-name').value;
                const lotName = document.getElementById('lot-name').value;
                const species = document.getElementById('species').value;
                const variety = document.getElementById('variety').value;
                const netWeight = parseFloat(document.getElementById('net-weight').value);

                if (!date || !producer || !netWeight) {
                    throw new Error("Fecha, Productor y Peso Neto son obligatorios.");
                }

                const docData = {
                    date: date,
                    producer: producer,
                    description: `${lotName} - ${species} (${variety})`,
                    stockKg: netWeight,
                    createdAt: serverTimestamp() 
                };

                const inventoryCollectionPath = `artifacts/${appId}/users/${userId}/inventory`;
                const docRef = await addDoc(collection(db, inventoryCollectionPath), docData);

                console.log("Recepción guardada con ID: ", docRef.id);
                receptionForm.reset(); // Limpiar formulario
                // Restaurar valores por defecto
                document.getElementById('producer-name').value = "Pinebloom";
                document.getElementById('lot-name').value = "Pinebloom Orange";
                document.getElementById('species').value = "Naranjas";
                document.getElementById('variety').value = "Valencia";

            } catch (error) {
                console.error("Error al guardar recepción: ", error);
                receptionError.textContent = `Error: ${error.message}`;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "Registrar en Inventario";
            }
        }
        
        // Abrir modal de edición de inventario (READ)
        function openEditInventoryModal(lotId) {
            const item = localInventoryCache.get(lotId);
            if (!item) {
                alert("Error: No se pudo encontrar el item en la caché local.");
                return;
            }
            
            document.getElementById('edit-inventory-id').value = item.id;
            document.getElementById('edit-reception-date').value = item.date;
            document.getElementById('edit-producer-name').value = item.producer;
            document.getElementById('edit-description').value = item.description;
            document.getElementById('edit-net-weight').value = item.stockKg;
            editInventoryError.textContent = '';
            
            showModal(editInventoryModal);
        }
        
        // Guardar cambios de edición de inventario (UPDATE)
        async function handleEditInventorySubmit(e) {
            e.preventDefault();
            const lotId = document.getElementById('edit-inventory-id').value;
            if (!db || !userId || !lotId) {
                editInventoryError.textContent = "Error: No hay conexión o ID de lote no válido.";
                return;
            }
            
            const submitButton = document.getElementById('save-edit-inventory-btn');
            submitButton.disabled = true;
            submitButton.textContent = "Guardando...";
            editInventoryError.textContent = '';

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/inventory`, lotId);
                
                const updatedData = {
                    date: document.getElementById('edit-reception-date').value,
                    producer: document.getElementById('edit-producer-name').value,
                    description: document.getElementById('edit-description').value,
                    stockKg: parseFloat(document.getElementById('edit-net-weight').value)
                };
                
                if (!updatedData.date || !updatedData.producer || !updatedData.description || isNaN(updatedData.stockKg)) {
                    throw new Error("Todos los campos son obligatorios y el stock debe ser un número.");
                }

                await updateDoc(docRef, updatedData);
                
                console.log("Inventario actualizado para Lote ID:", lotId);
                closeModal(editInventoryModal);

            } catch (error) {
                console.error("Error al actualizar inventario:", error);
                editInventoryError.textContent = `Error: ${error.message}`;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "Guardar Cambios";
            }
        }
        
        // Manejar borrado de inventario (DELETE)
        async function handleDeleteInventory(lotId) {
            const confirmed = await showConfirmationModal(
                '¿Borrar Recepción?',
                `¿Estás seguro de que quieres borrar la recepción con Lote ID: ${lotId}? Esta acción no se puede deshacer.`,
                'Sí, Borrar',
                'bg-red-600 hover:bg-red-700'
            );

            if (!confirmed) return;
            
            if (!db || !userId) {
                alert("Error: No hay conexión a la base de datos.");
                return;
            }

            try {
                // TODO: Añadir lógica para verificar si este lote está siendo usado en alguna venta.
                // Por ahora, permitimos el borrado directo.
                
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/inventory`, lotId);
                await deleteDoc(docRef);
                
                console.log("Lote de inventario borrado:", lotId);
                
            } catch (error) {
                console.error("Error al borrar lote de inventario:", error);
                alert(`Error: ${error.message}`);
            }
        }

        // --- Lógica de Venta (Modal y Factura) ---

        // Resetear y abrir el modal de venta
        function openSaleModal() {
            saleForm.reset();
            // Poner valores por defecto
            document.getElementById('sale-customer').value = "Jacmor Farms";
            document.getElementById('sale-date').value = new Date().toISOString().split('T')[0];
            // Lógica simple para sugerir siguiente ID de factura
            const lastSale = localSalesCache.length > 0 ? localSalesCache[localSalesCache.length - 1] : null;
            const nextId = lastSale ? (parseInt(lastSale.invoiceId) || 0) + 1 : 1;
            document.getElementById('sale-invoice-id').value = nextId;
            
            saleProductLines.innerHTML = '';
            saleInventoryLines.innerHTML = '';
            saleErrorMessage.textContent = '';
            
            // Añadir una línea de producto y una de inventario por defecto
            addProductLine();
            addInventoryLine();
            
            showModal(saleModal);
        }

        // Añadir una fila de línea de producto
        function addProductLine() {
            const lineId = `product-${Date.now()}`;
            const div = document.createElement('div');
            div.id = lineId;
            div.className = "grid grid-cols-12 gap-2 items-center";
            div.innerHTML = `
                <div class="col-span-5">
                    <label class="text-sm text-gray-600">Descripción</label>
                    <input type="text" value="2 lb Clams" data-field="description" class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="col-span-2">
                    <label class="text-sm text-gray-600">Cant.</label>
                    <input type="number" value="250" data-field="qty" class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="col-span-2">
                    <label class="text-sm text-gray-600">Precio U.</label>
                    <input type="number" value="4.00" step="0.01" data-field="price" class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="col-span-2">
                    <label class="text-sm text-gray-600">Total</label>
                    <input type="text" value="$1,000.00" data-field="total" class="mt-1 block w-full px-2 py-1 border bg-gray-100 border-gray-300 rounded-md shadow-sm sm:text-sm" readonly>
                </div>
                <div class="col-span-1 flex items-end justify-center">
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="mt-5 p-1 text-red-500 hover:text-red-700">&times;</button>
                </div>
            `;
            
            // Calcular total de línea automáticamente
            div.addEventListener('input', (e) => {
                if (e.target.dataset.field === 'qty' || e.target.dataset.field === 'price') {
                    const qty = parseFloat(div.querySelector('[data-field="qty"]').value) || 0;
                    const price = parseFloat(div.querySelector('[data-field="price"]').value) || 0;
                    const totalInput = div.querySelector('[data-field="total"]');
                    totalInput.value = formatCurrency(qty * price);
                }
            });

            saleProductLines.appendChild(div);
        }

        // Generar el HTML de las opciones del selector de inventario
        function getInventoryOptionsHTML() {
            if (localInventoryCache.size === 0) {
                return '<option value="">No hay lotes en inventario</option>';
            }
            let options = '<option value="">Seleccione un lote...</option>';
            localInventoryCache.forEach((item, lotId) => {
                if (item.stockKg > 0) { // Solo mostrar lotes con stock
                    options += `<option value="${lotId}">${item.description} (Stock: ${formatNumber(item.stockKg)} Kg)</option>`;
                }
            });
            return options;
        }

        // Añadir una fila de descuento de inventario
        function addInventoryLine() {
            const lineId = `inventory-${Date.now()}`;
            const div = document.createElement('div');
            div.id = lineId;
            div.className = "grid grid-cols-12 gap-2 items-center";
            div.innerHTML = `
                <div class="col-span-7">
                    <label class="text-sm text-gray-600">Lote de Materia Prima</label>
                    <select data-field="lotId" class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                        ${getInventoryOptionsHTML()}
                    </select>
                </div>
                <div class="col-span-4">
                    <label class="text-sm text-gray-600">Kg a Descontar</label>
                    <input type="number" step="0.01" data-field="kgToDiscount" class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="col-span-1 flex items-end justify-center">
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="mt-5 p-1 text-red-500 hover:text-red-700">&times;</button>
                </div>
            `;
            saleInventoryLines.appendChild(div);
        }
        
        // Actualizar selectores si el inventario cambia (llamado por onSnapshot)
        function updateInventorySelectors() {
            const selects = saleInventoryLines.querySelectorAll('select[data-field="lotId"]');
            selects.forEach(select => {
                const selectedValue = select.value;
                select.innerHTML = getInventoryOptionsHTML();
                select.value = selectedValue; // Intentar re-seleccionar el valor anterior
            });
        }
        
        // --- Lógica de Generación y Confirmación de Factura ---

        // Validar el formulario de venta y recolectar datos
        function validateAndCollectSaleData() {
            saleErrorMessage.textContent = '';
            
            // 1. Recolectar datos del cliente
            const customer = document.getElementById('sale-customer').value.trim();
            const date = document.getElementById('sale-date').value;
            const invoiceId = document.getElementById('sale-invoice-id').value.trim();
            
            if (!customer || !date || !invoiceId) {
                return { error: "Por favor complete todos los Datos del Cliente (Facturar a, Fecha, Factura #)." };
            }

            // 2. Recolectar líneas de producto
            const productLines = [];
            let subtotal = 0;
            const productLineElements = saleProductLines.querySelectorAll('div[id^="product-"]');
            
            if (productLineElements.length === 0) {
                return { error: "Debe añadir al menos una Línea de Producto a la venta." };
            }

            for (const line of productLineElements) {
                const description = line.querySelector('[data-field="description"]').value.trim();
                const qty = parseFloat(line.querySelector('[data-field="qty"]').value);
                const price = parseFloat(line.querySelector('[data-field="price"]').value);
                
                if (!description || isNaN(qty) || qty <= 0 || isNaN(price)) {
                    return { error: "Revise las líneas de producto. Todas deben tener descripción, cantidad válida y precio." };
                }
                const lineTotal = qty * price;
                subtotal += lineTotal;
                productLines.push({ description, qty, price, lineTotal });
            }

            // 3. Recolectar descuentos de inventario
            const inventoryLines = [];
            const inventoryLineElements = saleInventoryLines.querySelectorAll('div[id^="inventory-"]');
            
            if (inventoryLineElements.length === 0) {
                return { error: "Debe añadir al menos un Lote a Descontar del inventario." };
            }
            
            // Usar un mapa para agrupar descuentos por loteId (si el usuario selecciona el mismo lote varias veces)
            const kgToDiscountByLot = new Map();
            for (const line of inventoryLineElements) {
                const lotId = line.querySelector('[data-field="lotId"]').value;
                const kgToDiscount = parseFloat(line.querySelector('[data-field="kgToDiscount"]').value);

                if (!lotId || isNaN(kgToDiscount) || kgToDiscount <= 0) {
                    return { error: "Revise los descuentos de inventario. Todos deben tener un lote seleccionado y Kg válidos." };
                }
                
                const currentDiscount = kgToDiscountByLot.get(lotId) || 0;
                kgToDiscountByLot.set(lotId, currentDiscount + kgToDiscount);
            }

            // 4. Validar Stock
            for (const [lotId, totalKgToDiscount] of kgToDiscountByLot.entries()) {
                const lotData = localInventoryCache.get(lotId);
                if (!lotData) {
                    return { error: `El lote ${lotId} no se encuentra en el inventario local. Espere a que cargue.` };
                }
                if (lotData.stockKg < totalKgToDiscount) {
                    return { error: `Stock insuficiente para el lote ${lotData.description}. Stock: ${lotData.stockKg} Kg, Intenta descontar: ${totalKgToDiscount} Kg.` };
                }
                
                // Si el stock es suficiente, añadir a la lista final
                const selectElement = saleInventoryLines.querySelector(`select[value="${lotId}"]`);
                const lotDescription = selectElement ? selectElement.options[selectElement.selectedIndex].text : lotId;

                inventoryLines.push({
                    lotId: lotId,
                    lotDesc: lotDescription.split(' (Stock:')[0], // Tomar solo la descripción
                    kgToDiscount: totalKgToDiscount
                });
            }

            // 5. Retornar datos validados
            return {
                data: {
                    customer: customer,
                    date: date,
                    invoiceId: invoiceId,
                    productLines: productLines,
                    inventoryLines: inventoryLines, // Ya agrupados por lote
                    subtotal: subtotal,
                    total: subtotal // (asumiendo 0 impuestos)
                }
            };
        }

        // Manejar clic en "Previsualizar Factura"
        async function handlePreviewInvoice() {
            console.log("Manejando previsualización de factura...");
            const { data, error } = validateAndCollectSaleData();
            
            if (error) {
                console.error("Error de validación:", error);
                saleErrorMessage.textContent = error;
                // Hacer scroll hasta el error
                saleModal.querySelector('.modal-content').scrollTop = saleModal.querySelector('.modal-content').scrollHeight;
                return;
            }

            // Guardar datos validados en la variable global
            currentSaleData = data;
            
            // Renderizar la factura en el modal
            renderInvoicePreview(currentSaleData);
            
            // Ocultar modal de venta y mostrar modal de factura
            closeModal(saleModal);
            showModal(invoiceModal);
            
            // Limpiar errores anteriores
            invoiceConfirmError.textContent = '';
            confirmAndSaveBtn.disabled = false;
            confirmAndSaveBtn.textContent = 'Confirmar y Guardar Venta';
        }

        // Renderizar la previsualización de la factura
        function renderInvoicePreview(data) {
            console.log("Renderizando previsualización:", data);
            
            // Metadatos
            document.getElementById('invoice-date-val').textContent = data.date;
            document.getElementById('invoice-id-val').textContent = data.invoiceId;
            document.getElementById('invoice-customer-val').textContent = data.customer;

            // Líneas de producto
            const itemsBody = document.getElementById('invoice-items-body');
            itemsBody.innerHTML = '';
            data.productLines.forEach(line => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatNumber(line.qty)}</td>
                    <td>${line.description}</td>
                    <td class="text-right">${formatCurrency(line.price)}</td>
                    <td class="text-right">${formatCurrency(line.lineTotal)}</td>
                `;
                itemsBody.appendChild(tr);
            });

            // Rellenar con líneas vacías para que se parezca al formato
            const emptyRows = 10 - data.productLines.length;
            for (let i = 0; i < emptyRows; i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td>&nbsp;</td><td></td><td></td><td></td>';
                // Añadir estilo de borde a todas menos la última
                if (i < emptyRows - 1) {
                    tr.style.borderBottom = '1px solid #ccc';
                }
                itemsBody.appendChild(tr);
            }

            // Totales
            document.getElementById('invoice-subtotal-val').textContent = formatCurrency(data.subtotal);
            document.getElementById('invoice-total-val').textContent = formatCurrency(data.total);
        }

        // Manejar clic en "Confirmar y Guardar Venta"
        async function handleConfirmAndSaveSale() {
            console.log("Confirmando y guardando venta...");
            if (!db || !userId || !currentSaleData) {
                invoiceConfirmError.textContent = 'Error: No hay conexión o datos de venta.';
                return;
            }

            confirmAndSaveBtn.disabled = true;
            confirmAndSaveBtn.textContent = 'Guardando...';
            invoiceConfirmError.textContent = '';

            try {
                // Usar una transacción de Firestore para asegurar consistencia
                await runTransaction(db, async (transaction) => {
                    const inventoryRefs = new Map();
                    const inventoryDocs = new Map();
                    
                    // 1. Obtener todos los documentos de inventario necesarios
                    for (const line of currentSaleData.inventoryLines) {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/inventory`, line.lotId);
                        inventoryRefs.set(line.lotId, docRef);
                        const invDoc = await transaction.get(docRef);
                        if (!invDoc.exists()) {
                            throw new Error(`Error: El lote ${line.lotId} no existe.`);
                        }
                        inventoryDocs.set(line.lotId, invDoc);
                    }

                    // 2. Validar stock (doble chequeo dentro de la transacción)
                    for (const line of currentSaleData.inventoryLines) {
                        const invDoc = inventoryDocs.get(line.lotId);
                        const currentStock = invDoc.data().stockKg;
                        if (currentStock < line.kgToDiscount) {
                            throw new Error(`Stock insuficiente para ${invDoc.data().description}. Stock: ${currentStock} Kg, Requerido: ${line.kgToDiscount} Kg.`);
                        }
                    }

                    // 3. Actualizar (descontar) el inventario
                    for (const line of currentSaleData.inventoryLines) {
                        const docRef = inventoryRefs.get(line.lotId);
                        const invDoc = inventoryDocs.get(line.lotId);
                        const newStock = invDoc.data().stockKg - line.kgToDiscount;
                        transaction.update(docRef, { stockKg: newStock });
                    }

                    // 4. Guardar el registro de la venta
                    const saleDocData = {
                        ...currentSaleData,
                        createdAt: serverTimestamp()
                    };
                    const salesCollectionPath = `artifacts/${appId}/users/${userId}/sales`;
                    const newSaleRef = doc(collection(db, salesCollectionPath)); // Crear referencia para obtener ID
                    transaction.set(newSaleRef, saleDocData);
                    
                    console.log("Transacción exitosa. Venta guardada con ID:", newSaleRef.id);
                    // Actualizar el ID de factura para el PDF
                    currentSaleData.generatedSaleId = newSaleRef.id;
                });

                // 5. Si la transacción fue exitosa, generar y descargar el PDF
                downloadPdf();
                
                // 6. Cerrar modal y limpiar
                closeModal(invoiceModal);
                currentSaleData = {}; // Limpiar datos de venta

            } catch (error) {
                console.error("Error en la transacción de venta:", error);
                invoiceConfirmError.textContent = `Error: ${error.message}`;
                confirmAndSaveBtn.disabled = false;
                confirmAndSaveBtn.textContent = 'Confirmar y Guardar Venta';
            }
        }
        
        // Generar y descargar el PDF
        function downloadPdf() {
            console.log("Generando PDF...");
            const element = document.getElementById('invoice-preview');
            const opt = {
                margin:       0.5,
                filename:     `Factura_${currentSaleData.invoiceId}_${currentSaleData.customer}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            // Clonar el elemento para asegurar que el estilo sea correcto para el PDF
            const elementToPrint = element.cloneNode(true);
            elementToPrint.style.maxWidth = '7.5in'; // Ancho de hoja carta (8.5) menos márgenes (1.0)
            elementToPrint.style.padding = '0'; // Padding ya está en el contenedor de PDF
            elementToPrint.style.boxShadow = 'none';
            elementToPrint.style.border = 'none';

            // Añadir el clon temporalmente al body para que html2pdf lo renderice
            document.body.appendChild(elementToPrint);
            
            html2pdf().from(elementToPrint).set(opt).save().then(() => {
                // Remover el clon después de generar el PDF
                document.body.removeChild(elementToPrint);
                console.log("PDF generado y descargado.");
            });
        }


        // --- Lógica de Resumen de Ventas (Anulación y CSV) ---
        
        let localSalesCache = []; // Cache local de ventas para CSV

        // Renderizar tabla de resumen de ventas
        function renderSalesSummary(docs) {
            salesSummaryTableBody.innerHTML = ''; // Limpiar tabla
            localSalesCache = []; // Limpiar cache local

            if (docs.empty) {
                salesSummaryTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay ventas registradas.</td></tr>';
                return;
            }
            
            const sales = [];
            docs.forEach(doc => {
                sales.push({ id: doc.id, ...doc.data() });
            });
            
            // Ordenar por fecha o ID de factura (opcional pero útil)
            sales.sort((a, b) => (a.invoiceId > b.invoiceId) ? 1 : -1);

            // Guardar en cache para CSV
            localSalesCache = sales;

            sales.forEach(sale => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.invoiceId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.customer}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.productLines.length}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">${formatCurrency(sale.total)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="action-btn delete-btn" data-id="${sale.id}">Anular</button>
                    </td>
                `;
                
                // Asignar evento al botón de anular
                tr.querySelector('.delete-btn').addEventListener('click', () => handleAnnulSale(sale.id, sale.invoiceId, sale.inventoryLines));
                
                salesSummaryTableBody.appendChild(tr);
            });
        }

        // Cargar resumen de ventas (con listener en tiempo real)
        function loadSalesSummary() {
            if (!db || !userId) return;

            // Desconectar listener anterior si existe
            if (salesListener) salesListener();

            const salesCollectionPath = `artifacts/${appId}/users/${userId}/sales`;
            const q = query(collection(db, salesCollectionPath));

            console.log("Escuchando ventas en:", salesCollectionPath);

            salesListener = onSnapshot(q, (snapshot) => {
                console.log("Resumen de ventas actualizado, docs:", snapshot.size);
                renderSalesSummary(snapshot);
            }, (error) => {
                console.error("Error al cargar resumen de ventas: ", error);
                salesSummaryTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error al cargar ventas: ${error.message}</td></tr>`;
            });
        }
        
        // Manejar Anulación de Venta (DELETE Venta, UPDATE Inventario)
        async function handleAnnulSale(saleDocId, saleInvoiceId, inventoryLines) {
            const confirmed = await showConfirmationModal(
                '¿Anular Venta?',
                `¿Estás seguro de anular la Factura #${saleInvoiceId}? Esta acción borrará la venta y DEVOLVERÁ el stock descontado al inventario.`,
                'Sí, Anular Venta',
                'bg-red-600 hover:bg-red-700'
            );

            if (!confirmed) return;
            
            if (!db || !userId) {
                alert("Error: No hay conexión a la base de datos.");
                return;
            }
            
            console.log(`Anulando venta ${saleDocId}, devolviendo stock:`, inventoryLines);

            try {
                // Usar una transacción para asegurar que se borre la venta Y se devuelva el stock
                await runTransaction(db, async (transaction) => {
                    // 1. Referencia a la venta
                    const saleDocRef = doc(db, `artifacts/${appId}/users/${userId}/sales`, saleDocId);
                    
                    // 2. Obtener y actualizar (restaurar) inventario
                    for (const line of inventoryLines) {
                        const invDocRef = doc(db, `artifacts/${appId}/users/${userId}/inventory`, line.lotId);
                        const invDoc = await transaction.get(invDocRef);
                        
                        if (!invDoc.exists()) {
                            // El lote fue borrado, no podemos devolver el stock. 
                            // O podríamos recrearlo, pero por ahora solo logueamos el error.
                            console.warn(`No se pudo devolver stock al lote ${line.lotId} porque no existe.`);
                        } else {
                            const currentStock = invDoc.data().stockKg;
                            const newStock = currentStock + line.kgToDiscount;
                            transaction.update(invDocRef, { stockKg: newStock });
                            console.log(`Stock para ${line.lotId} restaurado de ${currentStock} a ${newStock}`);
                        }
                    }
                    
                    // 3. Borrar la venta
                    transaction.delete(saleDocRef);
                });
                
                console.log("Venta anulada y stock restaurado exitosamente.");

            } catch (error) {
                console.error("Error en la transacción de anulación:", error);
                alert(`Error al anular la venta: ${error.message}`);
            }
        }
        
        // Función para descargar CSV
        function downloadCSV() {
            if (localSalesCache.length === 0) {
                alert("No hay ventas para exportar.");
                return;
            }

            // Encabezados (similares a la imagen de ejemplo)
            const headers = [
                "Invoice #", "Date", "Bill to", "Variety", "Packaging", 
                "Pounds", "Boxes", "Price Each", "Amount"
                // Añadimos campos extra para trazabilidad
                ,"Lote Descontado ID", "Lote Descontado Desc", "Kg Descontados"
            ];
            
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";

            // Procesar cada venta
            localSalesCache.forEach(sale => {
                // Crear una fila por CADA línea de producto
                sale.productLines.forEach((line, index) => {
                    // Para el CSV, imitamos la estructura de la imagen
                    const variety = line.description.includes("Kishu") ? "CITRUS Kishu" : 
                                    line.description.includes("Tango") ? "CITRUS Tango" : 
                                    line.description.includes("Cara") ? "CITRUS Cara" : "N/A";
                    const packaging = line.description;
                    
                    // Intentar extraer el peso (ej: "2 lb") de la descripción
                    const weightMatch = line.description.match(/(\d+(\.\d+)?)\s*lb/i);
                    const lineWeight = weightMatch ? parseFloat(weightMatch[1]) : 0;
                    
                    const pounds = line.qty * lineWeight;
                    const boxes = line.qty;
                    const priceEach = line.price;
                    const amount = line.lineTotal;
                    
                    // Para la primera línea de producto, mostrar el detalle del primer descuento de inventario
                    // Para las siguientes, dejarlas en blanco para evitar duplicados
                    let lotId = '';
                    let lotDesc = '';
                    let kgDiscount = '';

                    if (index < sale.inventoryLines.length) {
                        const invLine = sale.inventoryLines[index];
                        lotId = `"${invLine.lotId}"`;
                        lotDesc = `"${invLine.lotDesc}"`;
                        kgDiscount = invLine.kgToDiscount;
                    }
                    
                    const row = [
                        sale.invoiceId,
                        sale.date,
                        `"${sale.customer}"`,
                        variety,
                        `"${packaging}"`,
                        pounds,
                        boxes,
                        priceEach,
                        amount,
                        lotId,
                        lotDesc,
                        kgDiscount
                    ];
                    
                    csvContent += row.join(",") + "\n";
                });
            });

            // Crear y descargar el archivo
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "resumen_de_ventas.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- Asignación de Eventos (Event Listeners) ---
        
        window.addEventListener('load', initFirebase);
        
        receptionForm.addEventListener('submit', handleReceptionSubmit);
        
        // Modales
        openSaleModalBtn.addEventListener('click', openSaleModal);
        closeSaleModalBtn.addEventListener('click', () => closeModal(saleModal));
        closeInvoiceModalBtn.addEventListener('click', () => closeModal(invoiceModal));
        closeEditInventoryModalBtn.addEventListener('click', () => closeModal(editInventoryModal));
        
        // Botones del modal de venta
        addProductLineBtn.addEventListener('click', addProductLine);
        addInventoryLineBtn.addEventListener('click', addInventoryLine);
        previewInvoiceBtn.addEventListener('click', handlePreviewInvoice);
        
        // Botón de confirmación (modal de factura)
        confirmAndSaveBtn.addEventListener('click', handleConfirmAndSaveSale);
        
        // Formulario de edición de inventario
        editInventoryForm.addEventListener('submit', handleEditInventorySubmit);

        // Botón CSV
        downloadCsvBtn.addEventListener('click', downloadCSV);

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            if (event.target == saleModal) {
                closeModal(saleModal);
            }
            if (event.target == invoiceModal) {
                closeModal(invoiceModal);
            }
            if (event.target == editInventoryModal) {
                closeModal(editInventoryModal);
            }
            if (event.target == confirmModal) {
                closeModal(confirmModal);
            }
        }
        
    </script>
</body>
</html>
