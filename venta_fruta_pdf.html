<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Recepción y Venta de Fruta</title>
    <!-- Incluimos Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 
      PASO CLAVE: Importamos la librería html2pdf.js para generar el PDF
    -->
    <!-- CORREGIDO: xintegrity -> integrity -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
         /* Estilos para la factura (imitando la imagen) */
         #invoice-to-print {
            width: 100%;
            /* Ajustado: Reducido de 800px a 750px para asegurar que quepa en hoja carta */
            max-width: 750px; 
            margin: 0 auto;
            font-family: 'Times New Roman', Times, serif;
            color: #000;
            background-color: #fff;
            border: 1px solid #e5e7eb; /* Opcional: borde suave para la vista previa */
         }
         #invoice-to-print header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2.5rem; /* mb-10 */
            padding-bottom: 1rem;
            border-bottom: 1px solid #ccc;
         }
         #invoice-to-print .company-details {
            font-size: 0.875rem; /* 14px */
            line-height: 1.4;
         }
         #invoice-to-print .company-details p {
            margin: 0;
         }
         #invoice-to-print .invoice-details h1 {
            font-size: 2.25rem; /* 36px */
            font-weight: bold;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            text-align: right;
            color: #374151; /* text-gray-700 */
         }
         #invoice-to-print .invoice-details p {
            text-align: right;
            font-size: 0.875rem; /* 14px */
            margin: 0;
         }
         #invoice-to-print .invoice-details p strong {
            margin-right: 0.5rem;
         }
         
         #invoice-to-print .to-section {
            margin-bottom: 1.5rem; /* mb-6 */
            font-size: 0.875rem;
         }
         #invoice-to-print .to-section p {
            font-size: 0.75rem; /* 12px */
            text-transform: uppercase;
            color: #4b5563; /* text-gray-600 */
            margin-bottom: 0.25rem;
         }
         
         #invoice-to-print .invoice-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem; /* 14px */
         }
         #invoice-to-print .invoice-table th,
         #invoice-to-print .invoice-table td {
            border: 1px solid #ccc;
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
         }
         #invoice-to-print .invoice-table th {
            background-color: #e5e7eb; /* bg-gray-200 */
            text-align: left;
            text-transform: uppercase;
            font-size: 0.75rem; /* 12px */
            color: #374151;
         }
         
         /* Alineación específica para la tabla de items */
         #invoice-to-print .invoice-table thead th.text-right,
         #invoice-to-print .invoice-table tbody td.text-right {
             text-align: right;
         }

         #invoice-to-print .totals-section {
            margin-top: 2rem; /* mt-8 */
            display: flex;
            justify-content: flex-end;
         }
         #invoice-to-print .totals-table {
            width: 100%;
            max-width: 300px; /* Ancho max para la tabla de totales */
            border-collapse: collapse;
            font-size: 0.875rem; /* 14px */
         }
         #invoice-to-print .totals-table td {
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            border: 1px solid #ccc;
         }
         #invoice-to-print .totals-table td.label {
            text-align: right;
            font-weight: 600; /* semibold */
            color: #4b5563; /* text-gray-600 */
            background-color: #f9fafb; /* bg-gray-50 */
         }
         #invoice-to-print .totals-table td.label.total {
             font-weight: bold;
             color: #000;
             font-size: 1rem; /* 16px */
         }
         
         #invoice-to-print .footer-note {
            margin-top: 3rem; /* mt-12 */
            text-align: center;
            font-size: 0.875rem; /* 14px */
            color: #4b5563; /* text-gray-600 */
         }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-6 md:p-10">

        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Sistema de Recepción y Venta</h1>
            <p class="text-gray-600">Gestión de inventario de materia prima y generación de facturas de venta.</p>
        </header>

        <!-- NUEVO: Panel de Estado de Autenticación -->
        <div id="auth-status" class="mb-6 p-4 rounded-md text-sm font-medium text-center bg-yellow-100 text-yellow-700">
            <p>Conectando a la base de datos...</p>
        </div>

        <!-- Sección 1: Formulario de Recepción -->
        <section id="form-container" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-3">1. Registrar Recepción de Materia Prima</h2>
            
            <form id="reception-form" class="space-y-6">
                 <fieldset>
                    <legend class="text-lg font-medium text-gray-700 mb-2">Datos de Trazabilidad</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="reception-date" class="block text-sm font-medium text-gray-700">Fecha Recepción *</label>
                            <input type="date" id="reception-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="producer-name" class="block text-sm font-medium text-gray-700">Nombre Productor *</label>
                            <input type="text" id="producer-name" placeholder="Ej: Juan Pérez" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="farm-name" class="block text-sm font-medium text-gray-700">Nombre Predio / Lote</label>
                            <input type="text" id="farm-name" placeholder="Ej: Fundo Santa Ana" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend class="text-lg font-medium text-gray-700 mb-2">Datos del Producto</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="species" class="block text-sm font-medium text-gray-700">Especie</label>
                            <input type="text" id="species" value="Naranjas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-50" readonly>
                        </div>
                        <div>
                            <label for="variety" class="block text-sm font-medium text-gray-700">Variedad</label>
                            <input type="text" id="variety" placeholder="Ej: Navel, Valencia" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                         <div>
                            <label for="net-weight" class="block text-sm font-medium text-gray-700">Peso Neto (Kg) *</label>
                            <input type="number" id="net-weight" min="0" step="0.01" placeholder="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                        </div>
                    </div>
                </fieldset>
                <div id="reception-error" class="text-red-600 text-sm mt-2"></div>
                <div class="text-right">
                    <button type="submit" id="add-reception-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Registrar en Inventario
                    </button>
                </div>
            </form>
        </section>

        <!-- Botón para Nueva Venta -->
        <div class="flex justify-end mb-4">
            <button id="new-sale-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-lg font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                + Crear Nueva Venta
            </button>
        </div>

        <!-- Sección 2: Inventario de Materia Prima (Cámara) -->
        <section id="inventory-container" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-3">2. Inventario en Cámara (Materia Prima)</h2>
            
            <div class="overflow-x-auto">
                <table id="inventory-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lote ID</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productor</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Stock (Kg)</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body" class="bg-white divide-y divide-gray-200">
                        <tr id="empty-inventory-row">
                            <td colspan="5" class="px-4 py-4 text-sm text-gray-500 text-center">No hay materia prima en inventario.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- NUEVO: Sección 3: Resumen de Ventas -->
        <section id="sales-container" class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h2 class="text-2xl font-semibold">3. Resumen de Ventas</h2>
                <button id="download-excel-btn" class="inline-flex justify-center py-2 px-4 border border-green-600 shadow-sm text-sm font-medium rounded-md text-green-700 bg-white hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Descargar Excel (.csv)
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table id="sales-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice #</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Total</th>
                        </tr>
                    </thead>
                    <tbody id="sales-body" class="bg-white divide-y divide-gray-200">
                        <tr id="empty-sales-row">
                            <td colspan="4" class="px-4 py-4 text-sm text-gray-500 text-center">No hay ventas registradas.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Modal 1: Formulario de Venta (Para ingresar datos de la factura) -->
    <div id="sell-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <form id="sell-form">
                <div class="p-6 space-y-6">
                    <h3 class="text-2xl font-semibold">Generar Nueva Venta</h3>
                    
                    <!-- Datos Cliente y Factura -->
                    <fieldset class="border rounded-md p-4">
                        <legend class="text-lg font-medium text-gray-700 px-2">Datos del Cliente y Factura</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="sell-customer" class="block text-sm font-medium text-gray-700">Cliente (TO:) *</label>
                                <input type="text" id="sell-customer" placeholder="Ej: Jacmor Farms" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="sell-invoice-num" class="block text-sm font-medium text-gray-700">Invoice # *</label>
                                <input type="text" id="sell-invoice-num" placeholder="Ej: 1001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label for="sell-date" class="block text-sm font-medium text-gray-700">Date *</label>
                                <input type="date" id="sell-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Añadir Líneas de Factura (Múltiples) -->
                    <fieldset class="border rounded-md p-4">
                        <legend class="text-lg font-medium text-gray-700 px-2">Añadir Líneas de Factura</legend>
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                            <div class="md:col-span-3">
                                <label for="new-line-desc" class="block text-sm font-medium text-gray-700">Descripción (Cajas)</label>
                                <input type="text" id="new-line-desc" placeholder="Ej: 2 lb Clams" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div>
                                <label for="new-line-qty" class="block text-sm font-medium text-gray-700">Cantidad (QTY)</label>
                                <input type="number" id="new-line-qty" min="0" placeholder="Ej: 250" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div>
                                <label for="new-line-price" class="block text-sm font-medium text-gray-700">Precio Unitario ($)</label>
                                <input type="number" id="new-line-price" min="0" step="0.01" placeholder="Ej: 4.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div>
                                <button type="button" id="add-invoice-line-btn" class="w-full py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700">Añadir</button>
                            </div>
                        </div>
                        <div id="line-item-error" class="text-red-600 text-sm mt-2"></div>
                        
                        <!-- Tabla de líneas añadidas -->
                        <h4 class="text-base font-medium text-gray-700 mt-4 mb-2">Líneas en esta Factura</h4>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 text-xs uppercase">
                                <tr>
                                    <th class="px-2 py-2">Descripción</th>
                                    <th class="px-2 py-2">Qty</th>
                                    <th class="px-2 py-2">P. Unitario</th>
                                    <th class="px-2 py-2">Total</th>
                                    <th class="px-2 py-2">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="sell-items-body" class="bg-white divide-y divide-gray-200">
                                <!-- Las líneas se añadirán aquí -->
                            </tbody>
                        </table>
                    </fieldset>
                    
                    <!-- Descuento de Inventario (Múltiples Lotes) -->
                    <fieldset class="border rounded-md p-4">
                        <legend class="text-lg font-medium text-gray-700 px-2">Descuento de Inventario (Multi-Lote)</legend>
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                            <div class="md:col-span-3">
                                <label for="discount-lot-select" class="block text-sm font-medium text-gray-700">Lote de Origen</label>
                                <select id="discount-lot-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
                            </div>
                            <div>
                                <label for="discount-kg" class="block text-sm font-medium text-gray-700">Kg a Descontar</label>
                                <input type="number" id="discount-kg" min="0" step="0.01" placeholder="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div>
                                <button type="button" id="add-discount-btn" class="w-full py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700">Añadir</button>
                            </div>
                        </div>
                        <div id="discount-error" class="text-red-600 text-sm mt-2"></div>

                        <!-- Tabla de descuentos añadidos -->
                        <h4 class="text-base font-medium text-gray-700 mt-4 mb-2">Lotes a Descontar en esta Venta</h4>
                        <table class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50 text-xs uppercase">
                                <tr>
                                    <th class="px-2 py-2">Lote ID</th>
                                    <th class="px-2 py-2">Productor</th>
                                    <th class="px-2 py-2">Kg a Descontar</th>
                                    <th class="px-2 py-2">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="sell-discounts-body" class="bg-white divide-y divide-gray-200">
                                <!-- Los descuentos de lote se añadirán aquí -->
                            </tbody>
                        </table>
                    </fieldset>
                    
                    <div id="sell-form-error" class="text-red-600 text-center font-medium"></div>

                </div>
                <!-- Botones del Modal -->
                <div class="bg-gray-100 px-6 py-4 flex justify-end space-x-3 border-t">
                    <button type="button" class="close-modal-btn py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                        Previsualizar Factura
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal 2: Vista Previa de Factura (Para PDF) -->
    <div id="invoice-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-100 rounded-lg shadow-xl w-full max-w-5xl max-h-[95vh] overflow-y-auto">
            
            <div id="invoice-to-print" class="bg-white p-10">
                <header class="flex justify-between items-start mb-10">
                    <div class="company-details">
                        <p class="font-bold text-lg">PINEBLOOM FARMS LLC</p>
                        <p>545 Tarva Road</p>
                        <p>Albany, Geogia 31721</p>
                        <p>1-229-734-5611</p>
                        <p>pinebloompackingllc@gmail.com</p>
                    </div>
                    <div class="invoice-details">
                        <h1 class="mb-4">INVOICE</h1>
                        <p><strong>DATE</strong> <span id="inv-date">10/25/2024</span></p>
                        <p><strong>INVOICE #</strong> <span id="inv-number">1001</span></p>
                    </div>
                </header>

                <section class="to-section mb-6">
                    <p>TO</p>
                    <span id="inv-customer">Jacmor Farms</span>
                </section>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>PAYMENT TERMS</th>
                            <th>DUE DATE</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="inv-terms">Due on receipt</td>
                            <td id="inv-due-date">10/25/2024</td>
                        </tr>
                    </tbody>
                </table>

                <table class="invoice-table" style="margin-top: 2rem;">
                    <thead>
                        <tr>
                            <th>QTY</th>
                            <th>DESCRIPTION</th>
                            <th class="text-right">UNIT PRICE</th>
                            <th class="text-right">LINE TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="inv-items-body">
                        <!-- Las filas se insertarán aquí -->
                    </tbody>
                </table>
                
                <section class="totals-section">
                    <table class="totals-table">
                        <tbody>
                            <tr>
                                <td class="label">SUBTOTAL</td>
                                <td class="text-right" id="inv-subtotal">$0.00</td>
                            </tr>
                            <tr>
                                <td class="label">SALES TAX</td>
                                <td class="text-right" id="inv-sales-tax">$0.00</td>
                            </tr>
                            <tr>
                                <td class="label total">TOTAL</td>
                                <td class="text-right" id="inv-total">$0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <footer class="footer-note">
                    <p>Make all checks payable to Pinebloom Farms LLC</p>
                </footer>
            </div>

            <!-- Botones del Modal (Fuera del área de impresión) -->
            <div class="bg-gray-100 px-8 py-4 flex justify-end space-x-3 border-t">
                <button type="button" class="close-modal-btn py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cerrar
                </button>
                <button type="button" id="download-pdf-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                    Descargar PDF
                </button>
            </div>
        </div>
    </div>


    <!-- SDKs de Firebase -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            // --- VARIABLES GLOBALES DE FIREBASE ---
            let db, auth, userId, inventoryCollectionRef, salesCollectionRef; // NUEVO: salesCollectionRef
            let localInventory = []; // Caché local del inventario para validaciones
            let localSales = []; // NUEVO: Caché local de ventas para Excel

            // --- SELECTORES DE ELEMENTOS ---
            const receptionForm = document.getElementById('reception-form');
            const receptionError = document.getElementById('reception-error');
            const inventoryBody = document.getElementById('inventory-body');
            const emptyInventoryRow = document.getElementById('empty-inventory-row');
            
            const newSaleBtn = document.getElementById('new-sale-btn');

            // Modal de Venta (Formulario)
            const sellModal = document.getElementById('sell-modal');
            const sellForm = document.getElementById('sell-form');
            const sellFormError = document.getElementById('sell-form-error');

            const addInvoiceLineBtn = document.getElementById('add-invoice-line-btn');
            const sellItemsBody = document.getElementById('sell-items-body');
            const lineItemError = document.getElementById('line-item-error');

            const addDiscountBtn = document.getElementById('add-discount-btn');
            const discountLotSelect = document.getElementById('discount-lot-select');
            const sellDiscountsBody = document.getElementById('sell-discounts-body');
            const discountError = document.getElementById('discount-error');

            // Modal de Factura (PDF Preview)
            const invoiceModal = document.getElementById('invoice-modal');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');

            // Botones de cerrar modal
            const closeModalBtns = document.querySelectorAll('.close-modal-btn');

            // NUEVO: Selectores de Resumen de Ventas
            const salesBody = document.getElementById('sales-body');
            const emptySalesRow = document.getElementById('empty-sales-row');
            const downloadExcelBtn = document.getElementById('download-excel-btn');

            // NUEVO: Selector de estado de autenticación
            const authStatus = document.getElementById('auth-status');


            // --- INICIALIZACIÓN DE FIREBASE ---
            try {
                // Configuración de Firebase PROPORCIONADA POR EL USUARIO
                const firebaseConfig = {
                  apiKey: "AIzaSyB5-1MpNQMnsPULW7JZZ8aRHC08UM3IVHY",
                  authDomain: "orange-pbloom.firebaseapp.com",
                  projectId: "orange-pbloom",
                  storageBucket: "orange-pbloom.firebasestorage.app", // Corregido el TLD
                  messagingSenderId: "306332234261",
                  appId: "1:306332234261:web:a991cc5b30c2cfdfda941c",
                  measurementId: "G-Z185FETY22"
                };
                
                // Usar el appId de la configuración para las rutas de la base de datos
                const appId = firebaseConfig.appId; 

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Útil para desarrollo

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuario autenticado:", userId);
                        
                        // Actualizar panel de estado
                        authStatus.innerHTML = `<p>Conectado. ID de Usuario: ${userId}</p>`;
                        authStatus.classList.add('bg-green-100', 'text-green-700');
                        authStatus.classList.remove('bg-yellow-100', 'text-yellow-700', 'bg-red-100', 'text-red-700');

                        // Definir la ruta de la colección de INVENTARIO
                        // Usamos el appId de la configuración
                        inventoryCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/inventory`);
                        
                        // NUEVO: Definir la ruta de la colección de VENTAS
                        salesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/sales`);
                        
                        // Iniciar los listeners
                        setupInventoryListener();
                        setupSalesListener(); // NUEVO

                    } else {
                        // Si no hay usuario, autenticarse
                        console.log("Autenticando...");
                        authStatus.innerHTML = `<p>Autenticando...</p>`;
                        authStatus.classList.add('bg-yellow-100', 'text-yellow-700');

                        try {
                            // Mantenemos la lógica de autenticación del canvas/local
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                console.log("Intentando signInWithCustomToken...");
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                // Si no estamos en el canvas, nos autenticamos anónimamente
                                console.log("Intentando signInAnonymously...");
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.warn("Falló signInWithCustomToken (esto es normal si no estás en el canvas o el token no coincide):", error.message);
                            
                            // CORREGIDO: Añadido 'auth/custom-token-mismatch'
                            // Si falla el token (normal fuera del canvas) o la config no se encuentra, reintentar con anónimo
                            if (error.code === 'auth/configuration-not-found' || 
                                error.code === 'auth/invalid-custom-token' ||
                                error.code === 'auth/custom-token-mismatch') 
                            {
                                console.log("Reintentando con signInAnonymously...");
                                try {
                                    await signInAnonymously(auth);
                                } catch (anonError) {
                                    console.error("Error de autenticación anónima:", anonError);
                                    // Mostrar error específico en el panel de estado
                                    authStatus.innerHTML = `<p><strong>Error de autenticación:</strong> ${anonError.message}. Verifique que 'Autenticación Anónima' esté habilitada en Firebase.</p>`;
                                    authStatus.classList.add('bg-red-100', 'text-red-700');
                                    authStatus.classList.remove('bg-yellow-100', 'text-yellow-700');
                                    receptionError.textContent = "Error de autenticación anónima. Revisa la config. de Firebase.";
                                }
                            } else {
                                console.error("Error de autenticación:", error);
                                // Mostrar error genérico en el panel de estado
                                authStatus.innerHTML = `<p><strong>Error de autenticación:</strong> ${error.message}.</p>`;
                                authStatus.classList.add('bg-red-100', 'text-red-700');
                                authStatus.classList.remove('bg-yellow-100', 'text-yellow-700');
                                receptionError.textContent = "Error de autenticación. No se pueden guardar datos.";
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                // Mostrar un error más descriptivo
                document.body.innerHTML = `<div style="padding: 2rem; text-align: center; font-family: sans-serif; line-height: 1.6; color: #333;">
                                                <h1 style="color: #d9534f;">Error Crítico: No se pudo conectar a Firebase.</h1>
                                                <p style="color: #d9534f; font-weight: bold; background: #f2dede; padding: 1rem; border-radius: 8px; border: 1px solid #ebccd1; display: inline-block; max-width: 800px; text-align: left;">
                                                    Mensaje: ${error.message}
                                                </p>
                                                <p style="margin-top: 1.5rem;">Por favor, revise la consola para más detalles (Presione F12).</p>
                                                <p>Asegúrese de que la configuración de Firebase sea correcta y que el dominio esté autorizado.</p>
                                            </div>`;
            }

            // --- FUNCIONES DE FIREBASE (LISTENERS) ---

            /**
             * Escucha cambios en el inventario en tiempo real
             */
            function setupInventoryListener() {
                if (!inventoryCollectionRef) return;
                
                const q = query(inventoryCollectionRef); 

                onSnapshot(q, (snapshot) => {
                    localInventory = []; // Resetear caché
                    const inventoryDocs = [];
                    snapshot.forEach((doc) => {
                        const lot = { ...doc.data(), id: doc.id };
                        inventoryDocs.push(lot);
                        // Añadir solo lotes con stock al caché para ventas
                        if (lot.netWeight > 0) {
                            localInventory.push(lot);
                        }
                    });
                    renderInventory(inventoryDocs); // Actualizar tabla principal
                    populateLotSelect(); // Actualizar dropdown en modal de venta
                }, (error) => {
                    console.error("Error al escuchar inventario:", error);
                });
            }

            /**
             * NUEVO: Escucha cambios en las ventas en tiempo real
             */
            function setupSalesListener() {
                if (!salesCollectionRef) return;

                const q = query(salesCollectionRef);

                onSnapshot(q, (snapshot) => {
                    localSales = []; // Resetear caché de ventas
                    snapshot.forEach((doc) => {
                        localSales.push({ ...doc.data(), id: doc.id });
                    });
                    renderSalesSummary(localSales); // Actualizar tabla de resumen de ventas
                }, (error) => {
                    console.error("Error al escuchar ventas:", error);
                });
            }

            // --- FUNCIONES DE UTILIDAD ---
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
            };

            const formatNumber = (value) => {
                 return new Intl.NumberFormat('es-CL').format(value);
            };
            
            /**
             * Formatea fecha (objeto Date o string YYYY-MM-DD o Timestamp) a MM/DD/YYYY
             */
            const formatDate = (dateInput) => {
                if (!dateInput) return '';
                
                let date;
                if (dateInput.toDate) { // Es un Timestamp de Firebase
                    date = dateInput.toDate();
                } else if (typeof dateInput === 'string') { // Es un string YYYY-MM-DD
                    const parts = dateInput.split('-');
                    if (parts.length === 3) {
                         date = new Date(parts[0], parts[1] - 1, parts[2]);
                    } else {
                        return dateInput; // Devolver el string si no es el formato esperado
                    }
                } else if (dateInput instanceof Date) { // Ya es un objeto Date
                    date = dateInput;
                } else {
                    return '';
                }

                // Usar UTC para evitar problemas de zona horaria con las fechas de Firebase
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                const year = date.getUTCFullYear();
                return `${month}/${day}/${year}`;
            };


            // --- FUNCIONES DE RENDERIZADO ---

            /**
             * Actualiza la tabla del inventario en el HTML
             */
            const renderInventory = (inventoryDocs) => {
                inventoryBody.innerHTML = ''; // Limpiar tabla

                const activeLots = inventoryDocs.filter(lot => lot.netWeight > 0);

                if (activeLots.length === 0) {
                    inventoryBody.appendChild(emptyInventoryRow);
                    return;
                }

                activeLots.forEach(lot => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium whitespace-nowrap">LOTE-${lot.id.substring(0, 6)}...</td>
                        <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${formatDate(lot.receptionDate)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${lot.producerName}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${lot.species} ${lot.variety || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-semibold text-right whitespace-nowrap">${formatNumber(lot.netWeight)} Kg</td>
                    `;
                    inventoryBody.appendChild(tr);
                });
            };

            /**
             * NUEVO: Actualiza la tabla de resumen de ventas
             */
            const renderSalesSummary = (sales) => {
                salesBody.innerHTML = ''; // Limpiar tabla

                if (sales.length === 0) {
                    salesBody.appendChild(emptySalesRow);
                    return;
                }
                
                // Ordenar por fecha (más nuevas primero) si 'saleDate' es un Timestamp
                sales.sort((a, b) => b.saleDate.seconds - a.saleDate.seconds);

                sales.forEach(sale => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium whitespace-nowrap">${sale.invoiceNum}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${formatDate(sale.saleDate)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${sale.customerName}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-semibold text-right whitespace-nowrap">${formatCurrency(sale.totalAmount)}</td>
                    `;
                    salesBody.appendChild(tr);
                });
            };


            /**
             * Rellena el <select> de lotes en el modal de venta
             */
            const populateLotSelect = () => {
                discountLotSelect.innerHTML = '<option value="">Seleccione un lote</option>';
                localInventory.forEach(lot => {
                    const option = document.createElement('option');
                    option.value = lot.id;
                    option.textContent = `${lot.producerName} (LOTE-${lot.id.substring(0, 6)}) - ${formatNumber(lot.netWeight)} Kg disp.`;
                    discountLotSelect.appendChild(option);
                });
            };

            // --- FUNCIONES DE MODALES ---
            const showModal = (modal) => {
                console.log('Intentando mostrar modal:', modal.id);
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                } else {
                    console.error('showModal: Modal no encontrado');
                }
            };

            const hideModals = () => {
                console.log('Cerrando todos los modales');
                sellModal.classList.add('hidden');
                sellModal.classList.remove('flex');
                invoiceModal.classList.add('hidden');
                invoiceModal.classList.remove('flex');
            };
            
            const openNewSaleModal = () => {
                sellForm.reset();
                document.getElementById('sell-date').valueAsDate = new Date();
                sellItemsBody.innerHTML = '';
                sellDiscountsBody.innerHTML = '';
                sellFormError.textContent = '';
                lineItemError.textContent = '';
                discountError.textContent = '';
                showModal(sellModal);
            };

            // --- LÓGICA DE FORMULARIO DE VENTA (MULTI-LÍNEA / MULTI-LOTE) ---

            /**
             * Añade una línea de producto a la tabla del modal de venta
             */
            const addInvoiceLine = () => {
                lineItemError.textContent = '';
                const desc = document.getElementById('new-line-desc').value;
                const qty = parseFloat(document.getElementById('new-line-qty').value);
                const price = parseFloat(document.getElementById('new-line-price').value);

                if (!desc || !qty || !price || qty <= 0 || price <= 0) {
                    lineItemError.textContent = 'Debe rellenar Descripción, Cantidad (>0) y Precio (>0).';
                    return;
                }
                const lineTotal = qty * price;

                const tr = document.createElement('tr');
                tr.className = 'invoice-line-item';
                // Guardar datos en el dataset para usarlos al generar la factura
                tr.dataset.description = desc;
                tr.dataset.qty = qty;
                tr.dataset.unitPrice = price;
                
                tr.innerHTML = `
                    <td class="px-2 py-2 text-sm">${desc}</td>
                    <td class="px-2 py-2 text-sm text-right">${formatNumber(qty)}</td>
                    <td class="px-2 py-2 text-sm text-right">${formatCurrency(price)}</td>
                    <td class="px-2 py-2 text-sm text-right">${formatCurrency(lineTotal)}</td>
                    <td class="px-2 py-2 text-sm text-center">
                        <button type="button" class="remove-line-btn text-red-600 hover:text-red-800">&times;</button>
                    </td>
                `;
                
                tr.querySelector('.remove-line-btn').addEventListener('click', () => tr.remove());
                sellItemsBody.appendChild(tr);

                // Limpiar inputs
                document.getElementById('new-line-desc').value = '';
                document.getElementById('new-line-qty').value = '';
                document.getElementById('new-line-price').value = '';
            };

            /**
             * Añade un descuento de lote a la tabla del modal de venta
             */
            const addDiscountLine = () => {
                discountError.textContent = '';
                const lotId = discountLotSelect.value;
                const kgDiscount = parseFloat(document.getElementById('discount-kg').value);
                const selectedLot = localInventory.find(lot => lot.id === lotId);

                if (!selectedLot || !kgDiscount || kgDiscount <= 0) {
                    discountError.textContent = 'Seleccione un lote e ingrese Kg a descontar (>0).';
                    return;
                }

                if (kgDiscount > selectedLot.netWeight) {
                    discountError.textContent = `Error: No puede descontar ${kgDiscount} Kg. El lote solo tiene ${selectedLot.netWeight} Kg.`;
                    return;
                }
                
                // Evitar duplicados
                const existingDiscount = sellDiscountsBody.querySelector(`tr[data-lot-id="${lotId}"]`);
                if (existingDiscount) {
                    discountError.textContent = 'Ese lote ya fue añadido. Bórrelo para añadir un nuevo valor.';
                    return;
                }

                const tr = document.createElement('tr');
                tr.className = 'discount-line-item';
                tr.dataset.lotId = lotId;
                tr.dataset.kg = kgDiscount;
                tr.dataset.originalWeight = selectedLot.netWeight; // Guardar peso original

                tr.innerHTML = `
                    <td class="px-2 py-2 text-sm">LOTE-${lotId.substring(0, 6)}...</td>
                    <td class="px-2 py-2 text-sm">${selectedLot.producerName}</td>
                    <td class="px-2 py-2 text-sm text-right">${formatNumber(kgDiscount)} Kg</td>
                    <td class="px-2 py-2 text-sm text-center">
                        <button type="button" class="remove-line-btn text-red-600 hover:text-red-800">&times;</button>
                    </td>
                `;
                
                tr.querySelector('.remove-line-btn').addEventListener('click', () => tr.remove());
                sellDiscountsBody.appendChild(tr);

                // Limpiar inputs
                discountLotSelect.value = '';
                document.getElementById('discount-kg').value = '';
            };
            

            /**
             * Rellena la plantilla de la factura con los datos del formulario
             */
            const populateInvoice = (data) => {
                console.log("Poblando factura con datos:", data);
                const { customerName, invoiceNum, saleDate, lines } = data;
                
                // Rellenar cabecera
                document.getElementById('inv-date').textContent = formatDate(saleDate);
                document.getElementById('inv-number').textContent = invoiceNum;
                document.getElementById('inv-customer').textContent = customerName;
                document.getElementById('inv-due-date').textContent = formatDate(saleDate);

                // Rellenar líneas
                const itemsBody = document.getElementById('inv-items-body');
                itemsBody.innerHTML = '';
                let subtotal = 0;

                lines.forEach(line => {
                    const qty = parseFloat(line.qty);
                    const unitPrice = parseFloat(line.unitPrice);
                    const lineTotal = qty * unitPrice;
                    subtotal += lineTotal;
                    
                    itemsBody.innerHTML += `
                        <tr>
                            <td class="py-3 px-1">${formatNumber(qty)}</td>
                            <td class="py-3 px-1">${line.description}</td>
                            <td class="py-3 px-1 text-right">${formatCurrency(unitPrice)}</td>
                            <td class="py-3 px-1 text-right">${formatCurrency(lineTotal)}</td>
                        </tr>
                    `;
                });

                // Rellenar totales
                const salesTax = 0; // Se puede añadir lógica si es necesario
                const total = subtotal + salesTax;
                document.getElementById('inv-subtotal').textContent = formatCurrency(subtotal);
                document.getElementById('inv-sales-tax').textContent = formatCurrency(salesTax);
                document.getElementById('inv-total').textContent = formatCurrency(total);
                
                console.log("Factura poblada, mostrando modal #invoice-modal");
                showModal(invoiceModal);
            };

            /**
             * Descarga el PDF usando html2pdf.js
             */
            const downloadPDF = () => {
                const invoiceElement = document.getElementById('invoice-to-print');
                const invoiceNum = document.getElementById('inv-number').textContent;
                const customer = document.getElementById('inv-customer').textContent;

                const opt = {
                    margin:       0.5,
                    filename:     `Factura_${invoiceNum}_${customer}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                downloadPdfBtn.textContent = 'Generando...';
                downloadPdfBtn.disabled = true;

                html2pdf().from(invoiceElement).set(opt).save().then(() => {
                    downloadPdfBtn.textContent = 'Descargar PDF';
                    downloadPdfBtn.disabled = false;
                    hideModals();
                    sellForm.reset();
                });
            };

            /**
             * NUEVO: Lógica para descargar el resumen de ventas como CSV
             */
            
            // Función auxiliar para escapar valores para CSV
            const escapeCSV = (val) => {
                if (val == null) return '""';
                let str = String(val);
                str = str.replace(/"/g, '""'); // Escapar comillas dobles
                return `"${str}"`; // Envolver en comillas
            };

            const downloadExcel = () => {
                if (localSales.length === 0) {
                    alert('No hay ventas para exportar.');
                    return;
                }

                // Encabezados (similares a la imagen de ejemplo)
                let csvContent = "data:text/csv;charset=utf-8,";
                const headers = [
                    "Invoice #",
                    "Fecha",
                    "Cliente",
                    "Packaging (Descripcion)",
                    "Cantidad (Cajas)",
                    "Precio Unitario",
                    "Monto Linea",
                    "Lotes Descontados (Kg)" // Columna extra para trazabilidad
                ];
                csvContent += headers.join(",") + "\r\n";

                // Generar filas (una por CADA LÍNEA de CADA VENTA)
                localSales.forEach(sale => {
                    // Combinar los descuentos en un solo string para esta venta
                    const discountSummary = sale.discounts
                        .map(d => `LOTE-${d.lotId.substring(0,6)} (${d.kg} Kg)`)
                        .join('; ');

                    sale.lines.forEach(line => {
                        const lineTotal = parseFloat(line.qty) * parseFloat(line.unitPrice);
                        const row = [
                            escapeCSV(sale.invoiceNum),
                            escapeCSV(formatDate(sale.saleDate)),
                            escapeCSV(sale.customerName),
                            escapeCSV(line.description),
                            line.qty,
                            line.unitPrice,
                            lineTotal.toFixed(2),
                            escapeCSV(discountSummary) // Añadir el resumen de descuentos en cada línea
                        ];
                        csvContent += row.join(",") + "\r\n";
                    });
                });

                // Crear y descargar el archivo
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "resumen_ventas.csv");
                document.body.appendChild(link); 
                link.click();
                document.body.removeChild(link);
            };


            // --- EVENT LISTENERS ---

            // 1. Registrar Recepción (Materia Prima)
            receptionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                receptionError.textContent = '';
                
                const netWeight = parseFloat(document.getElementById('net-weight').value);
                if (!netWeight || netWeight <= 0) {
                    receptionError.textContent = 'El Peso Neto (Kg) debe ser mayor a 0.';
                    return;
                }
                
                if (!inventoryCollectionRef) {
                    receptionError.textContent = 'Error: No hay conexión a la base de datos.';
                    return;
                }

                const newLot = {
                    receptionDate: Timestamp.fromDate(document.getElementById('reception-date').valueAsDate),
                    producerName: document.getElementById('producer-name').value,
                    farmName: document.getElementById('farm-name').value,
                    species: document.getElementById('species').value,
                    variety: document.getElementById('variety').value,
                    netWeight: netWeight,
                };
                
                try {
                    await addDoc(inventoryCollectionRef, newLot);
                    receptionForm.reset();
                    document.getElementById('species').value = "Naranjas";
                    document.getElementById('reception-date').valueAsDate = new Date();
                } catch (error) {
                    console.error("Error al guardar en Firestore:", error);
                    receptionError.textContent = 'Error al guardar el lote. Intente de nuevo.';
                }
            });
            
            // 2. Abrir modal de nueva venta
            newSaleBtn.addEventListener('click', openNewSaleModal);

            // 3. Añadir línea de producto en modal
            addInvoiceLineBtn.addEventListener('click', addInvoiceLine);

            // 4. Añadir descuento de lote en modal
            addDiscountBtn.addEventListener('click', addDiscountLine);

            // 5. Enviar Formulario de Venta (Previsualizar Factura)
            sellForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Formulario de venta enviado. Iniciando validaciones...');
                sellFormError.textContent = '';
                
                // Recolectar líneas y descuentos
                const invoiceLines = Array.from(sellItemsBody.querySelectorAll('.invoice-line-item')).map(tr => tr.dataset);
                const discounts = Array.from(sellDiscountsBody.querySelectorAll('.discount-line-item')).map(tr => tr.dataset);

                // Validaciones
                if (invoiceLines.length === 0) {
                    sellFormError.textContent = 'Debe añadir al menos una línea de producto a la factura.';
                    console.warn('Validación fallida: Sin líneas de producto');
                    sellForm.scroll(0, sellForm.scrollHeight); // Hacer scroll al error
                    return;
                }
                if (discounts.length === 0) {
                    sellFormError.textContent = 'Debe añadir al menos un descuento de lote del inventario.';
                    console.warn('Validación fallida: Sin descuentos de lote');
                    sellForm.scroll(0, sellForm.scrollHeight); // Hacer scroll al error
                    return;
                }
                
                console.log('Validaciones OK. Procesando descuentos en BBDD...');
                
                // Procesar descuentos en BBDD
                try {
                    for (const discount of discounts) {
                        const lotId = discount.lotId;
                        const kgToDiscount = parseFloat(discount.kg);
                        
                        // Doble chequeo por si el stock cambió
                        const currentLot = localInventory.find(l => l.id === lotId);
                        if (!currentLot || currentLot.netWeight < kgToDiscount) {
                             throw new Error(`Stock insuficiente en LOTE-${lotId.substring(0,6)}`);
                        }

                        const newWeight = currentLot.netWeight - kgToDiscount;
                        const docRef = doc(inventoryCollectionRef, lotId);
                        await updateDoc(docRef, { netWeight: newWeight });
                    }
                    
                    console.log('Descuentos aplicados. Preparando registro de venta...');

                    // Preparar datos para la factura Y para guardar la venta
                    const saleDate = document.getElementById('sell-date').valueAsDate;
                    const totalAmount = invoiceLines.reduce((acc, line) => {
                        return acc + (parseFloat(line.qty) * parseFloat(line.unitPrice));
                    }, 0);

                    const saleRecord = {
                        customerName: document.getElementById('sell-customer').value,
                        invoiceNum: document.getElementById('sell-invoice-num').value,
                        saleDate: Timestamp.fromDate(saleDate), // Guardar como Timestamp
                        lines: invoiceLines,
                        discounts: discounts,
                        totalAmount: totalAmount
                    };

                    // NUEVO: Guardar el registro de la venta en Firestore
                    await addDoc(salesCollectionRef, saleRecord);
                    console.log('Registro de venta guardado en Firestore.');

                    // Preparar datos para el PDF (usa 'saleDate' como objeto Date, no Timestamp)
                    const invoiceDataForPDF = { ...saleRecord, saleDate: saleDate };
                    
                    hideModals(); // Ocultar modal de venta
                    populateInvoice(invoiceDataForPDF); // Poblar y mostrar modal de factura

                } catch (error) {
                    console.error("Error al procesar la venta:", error);
                    sellFormError.textContent = `Error: ${error.message}. La venta no se procesó.`;
                    sellForm.scroll(0, sellForm.scrollHeight); // Hacer scroll al error
                }
            });

            // 6. Descargar PDF
            downloadPdfBtn.addEventListener('click', downloadPDF);

            // 7. NUEVO: Descargar Excel
            downloadExcelBtn.addEventListener('click', downloadExcel);

            // 8. Cerrar Modales
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', hideModals);
            });
            
            // --- INICIALIZACIÓN ---
            document.getElementById('reception-date').valueAsDate = new Date();
        });
    </script>
</body>
</html>

